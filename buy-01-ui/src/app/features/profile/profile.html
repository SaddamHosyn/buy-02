<div class="profile-container">
  <mat-card class="profile-card">
    <div class="header-with-back">
      <button mat-icon-button (click)="goBack()" matTooltip="Go Back" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <mat-card-header>
        <mat-card-title>My Profile</mat-card-title>
        <mat-card-subtitle>Manage your profile and account settings</mat-card-subtitle>
      </mat-card-header>
    </div>

    <mat-card-content>
      <mat-tab-group>
        <!-- Dashboard Tab -->
        <mat-tab label="Dashboard">
          <div class="tab-content dashboard-tab">
            <!-- Loading State -->
            @if (statsLoading()) {
            <div class="loading-container">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Loading stats...</p>
            </div>
            } @else if (buyerStats()) {

            <!-- Summary Cards -->
            <div class="stats-summary">
              <mat-card class="stat-card">
                <mat-card-content>
                  <div class="stat-icon spent">
                    <mat-icon>attach_money</mat-icon>
                  </div>
                  <div class="stat-info">
                    <h2>€{{ buyerStats()?.totalSpent?.toFixed(2) }}</h2>
                    <p>Total Spent</p>
                  </div>
                </mat-card-content>
              </mat-card>

              <mat-card class="stat-card">
                <mat-card-content>
                  <div class="stat-icon orders">
                    <mat-icon>shopping_bag</mat-icon>
                  </div>
                  <div class="stat-info">
                    <h2>{{ buyerStats()?.totalOrders }}</h2>
                    <p>Total Orders</p>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="charts-grid">
              <!-- Top Categories Chart -->
              <mat-card class="chart-card">
                <mat-card-header>
                  <mat-card-title>Top Categories</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  @if (categoryChartData()) {
                  <div class="chart-container">
                    <canvas baseChart [data]="categoryChartData()" [type]="pieChartType" [options]="pieChartOptions">
                    </canvas>
                  </div>
                  }
                </mat-card-content>
              </mat-card>

              <!-- Most Bought Products Chart -->
              <mat-card class="chart-card">
                <mat-card-header>
                  <mat-card-title>Most Bought Products</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  @if (productsChartData()) {
                  <div class="chart-container">
                    <canvas baseChart [data]="productsChartData()" [type]="barChartType" [options]="barChartOptions">
                    </canvas>
                  </div>
                  }
                </mat-card-content>
              </mat-card>
            </div>
            }
          </div>
        </mat-tab>

        <!-- Profile Information Tab -->
        <mat-tab label="Profile Information">
          <div class="tab-content">
            <!-- Avatar Section -->
            <div class="avatar-section">
              @if (displayAvatar()) {
              <div class="avatar-container">
                <img [src]="displayAvatar()" alt="Profile avatar" class="profile-avatar" />
                <button mat-mini-fab color="warn" type="button" class="remove-avatar-btn" matTooltip="Remove avatar"
                  (click)="uploadAvatar()">
                  <!-- Note: Replaced remove with upload trigger since removeAvatar isn't in TS yet -->
                  <mat-icon>edit</mat-icon>
                </button>
              </div>
              } @else {
              <div class="no-avatar">
                <mat-icon>account_circle</mat-icon>
                <p>No avatar set</p>
              </div>
              }

              <!-- Upload Button -->
              <div class="upload-section">
                <input #avatarInput type="file" accept="image/*" (change)="onFileSelected($event)" hidden />
                <button mat-stroked-button color="primary" type="button" (click)="avatarInput.click()">
                  <mat-icon>cloud_upload</mat-icon>
                  {{ displayAvatar() ? 'Change Avatar' : 'Upload Avatar' }}
                </button>
                <p class="upload-hint">Max 2MB • JPEG, PNG, WebP</p>
              </div>

              <!-- Upload Error -->
              @if (uploadError()) {
              <div class="upload-error">
                <mat-icon>error</mat-icon>
                {{ uploadError() }}
              </div>
              }
            </div>

            <mat-divider class="section-divider"></mat-divider>

            <!-- Profile Form -->
            <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="profile-form">
              <!-- Name Field -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Full Name</mat-label>
                <input matInput type="text" formControlName="name" />
                <mat-icon matPrefix>person</mat-icon>
                @if (profileForm.get('name')?.invalid && profileForm.get('name')?.touched) {
                <mat-error>{{ getErrorMessage('name') }}</mat-error>
                }
              </mat-form-field>

              <!-- Email Field -->
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Email</mat-label>
                <input matInput type="email" formControlName="email" [readonly]="true" />
                <mat-icon matPrefix>email</mat-icon>
                @if (profileForm.get('email')?.invalid && profileForm.get('email')?.touched) {
                <mat-error>{{ getErrorMessage('email') }}</mat-error>
                }
              </mat-form-field>

              <!-- Role Display -->
              <div class="role-display">
                <mat-icon>{{
                  currentUser()?.role === 'SELLER' ? 'store' : 'shopping_cart'
                  }}</mat-icon>
                <span>{{ currentUser()?.role }}</span>
              </div>

              <!-- Submit Button -->
              <button mat-raised-button color="primary" type="submit" class="full-width submit-btn" [disabled]="
                  isLoading() || profileForm.invalid || (!profileForm.dirty && !selectedFile())
                ">
                @if (isLoading()) {
                <mat-spinner diameter="20"></mat-spinner>
                <span>Saving...</span>
                } @else {
                <ng-container>
                  <mat-icon>save</mat-icon>
                  <span>Save Changes</span>
                </ng-container>
                }
              </button>
            </form>
          </div>
        </mat-tab>

        <!-- Security Tab -->
        <mat-tab label="Security">
          <div class="tab-content">
            <mat-divider class="section-divider"></mat-divider>

            <!-- Change Password Section -->
            <div class="security-section">
              <div class="section-header">
                <div>
                  <h3>Change Password</h3>
                  <p>Update your password to keep your account secure</p>
                </div>
                <button mat-icon-button (click)="togglePasswordFields()">
                  <mat-icon>{{ showPasswordFields() ? 'expand_less' : 'expand_more' }}</mat-icon>
                </button>
              </div>

              @if (showPasswordFields()) {
              <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="password-form">
                <!-- Current Password -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Current Password</mat-label>
                  <input matInput type="password" formControlName="currentPassword" />
                  <mat-icon matPrefix>lock</mat-icon>
                  @if (passwordForm.get('currentPassword')?.invalid &&
                  passwordForm.get('currentPassword')?.touched) {
                  <mat-error>{{ getErrorMessage('currentPassword') }}</mat-error>
                  }
                </mat-form-field>

                <!-- New Password -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>New Password</mat-label>
                  <input matInput type="password" formControlName="newPassword" />
                  <mat-icon matPrefix>lock_outline</mat-icon>
                  @if (passwordForm.get('newPassword')?.invalid &&
                  passwordForm.get('newPassword')?.touched) {
                  <mat-error>{{ getErrorMessage('newPassword') }}</mat-error>
                  }
                </mat-form-field>

                <!-- Confirm Password -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Confirm New Password</mat-label>
                  <input matInput type="password" formControlName="confirmPassword" />
                  <mat-icon matPrefix>lock_outline</mat-icon>
                  @if (passwordForm.get('confirmPassword')?.invalid &&
                  passwordForm.get('confirmPassword')?.touched) {
                  <mat-error>{{ getErrorMessage('confirmPassword') }}</mat-error>
                  } @if (passwordForm.hasError('passwordMismatch') &&
                  passwordForm.get('confirmPassword')?.touched) {
                  <mat-error>Passwords do not match</mat-error>
                  }
                </mat-form-field>

                <button mat-raised-button color="primary" type="submit" class="full-width"
                  [disabled]="isLoading() || passwordForm.invalid">
                  <mat-icon>vpn_key</mat-icon>
                  Update Password
                </button>
              </form>
              }
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>
</div>